<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
		<script src="http://code.jquery.com/jquery-1.9.1.js"></script>
		<script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
		<script src = "http://d3js.org/d3.v3.min.js"></script>
		<script src="http://d3js.org/d3.v2.min.js?2.8.1"></script>
		<script src="../js/query.js"></script>
		<script src="http://static.cybercommons.org/js/d3/lib/colorbrewer/colorbrewer.js" type="text/javascript"></script>
		<link rel="stylesheet" href="css/style.css" />	
		<link rel="stylesheet" href="http://static.cybercommons.org/js/d3/lib/colorbrewer/colorbrewer.css" />	
		<script>
			var cuisine = getQueryVariable("cuisine");
			var dropDownNetType = ["Cooccurence in recipes", "Positive correlation of ingredients", "Negative correlation of ingredients", "Conditional probability", "Pairwise mutual information"];
			var dropDownNetTypeCodes = ["cooc", "ccf_pos", "ccf_neg", "cp", "pmi"];
			window.onload=function(){
				jsonFile = "data/" + cuisine + "_" + dropDownNetTypeCodes[0] + ".json";
				loadFile(jsonFile);
			}

		</script>
	</head>
	<body>
		<div>
			<div style="width: 500px; float: left;">
				<label for="chooseNetType" >Choose Network Type:</label>
				<select id="chooseNetType"></select>
			</div>
			<div style="margin-left: 500px;" >
				<ul class="check-list">
					<li>Pick a network type to see cuisine behavior. </li>
				</ul>
			</div>
		</div>
		<div>
			<div style="width: 600px; float: left;">
				<label for="chooseNode" >Choose Ingredient:</label>
				<select id="chooseNode"></select>	
				<p> </p>
				<div>
					<div style="width: 100px; float: left;">Zoom: </div>
					<div style="margin-left: 100px;">
						<div id="vslider" style="width: 300px; height: 6px;"></div>	
					</div>
				</div>
				<p> </p>
				<div>
					<div style="width: 100px; float: left;"> Choose Order: </div> 
					<div style="margin-left: 100px; ">
						<select id="order">
							<option value="name">by Name</option>
							<option value="count">by Frequency</option>
							<option value="degree">by Degree</option>
						</select>
					</div>
				</div>
			</div>
			<div style="margin-left: 500px;" >
				<ul class="check-list">
					<li>Pick an ingredient to see its culinary network. </li>
					<li>Use slider to zoom in/out of network. </li>
					<li>(Shift) dbl-click / mouse whl scroll (up)down to zoom (out) in </li>
				</ul>
			</div>
		</div>

		<div id="chart"> </div>
		<script>
			var dropDown = d3.select("#chooseNetType")
			    .on("change", function() {
					nodeId = this.selectedIndex;
					netType = dropDownNetTypeCodes[nodeId];
					var jsonFile = "data/" + cuisine + "_" + netType + ".json";
					loadFile(jsonFile);
				})
			    .selectAll("option")
			    .data(dropDownNetType)
			    .enter()
			    .append("option")
			    .attr("value", function(d) { return d;} )
			    .text(function(d) {return d;});

				
			var margin = {top: 50, right: 150, bottom: 50, left: 50},
			    width = 800,
			    height = 800;

			$(function() {
			$( "#vslider" ).slider({
				orientation: "horizontal",
				range: "min",
				min: 900,
				max: 10000,
				value: 1000,
				slide: function( event, ui ) {
					zoomWithSlider(ui.value/1000);
				}
			});
			});
			function zoomWithSlider(scale) {
				var svg = d3.select("#chart").select("svg");
				var container = svg.select("g");
				var h = svg.attr("height"), w = svg.attr("width");

				// Note: works only on the <g> element and not on the <svg> element
				// which is a common mistake
				container.attr("transform",
						"translate(" + w/2 + ", " + h/2 + ") " +
						"scale(" + scale + ") " +
						"translate(" + (-w/2) + ", " + (-h/2) + ")");
			}
			
			var orderingParam = "name";
			var x = d3.scale.ordinal().rangeBands([0, width]),
			    z = d3.scale.linear().domain([0, 1]).clamp(true),
			    c = d3.scale.ordinal().domain(d3.range(10)).range(colorbrewer.YlOrRd[9]);

			var svg = d3.select("#chart").append("svg:svg")
			    .attr("width", width + margin.left + margin.right)
			    .attr("height", height + margin.top + margin.bottom)
			    .attr('pointer-events', 'all')
			    .append('svg:g')
			    .call(d3.behavior.zoom().on("zoom", redraw))
			    .append('svg:g')
			    .style("margin-left", -margin.left-50 + "px")
			    .append("svg:g")
			    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
			
			function redraw() {
				console.log("here", d3.event.translate, d3.event.scale);
				svg.attr("transform",
						"translate(" + d3.event.translate + ")"
						+ " scale(" + d3.event.scale + ")");
			}
			function loadFile(jsonFile){
				d3.json(jsonFile, function(json) {
				  var matrix = [],
				      nodes = json.nodes.sort(),
				      n = nodes.length;

				  // Compute index per node.
				  nodes.forEach(function(node, i) {
				    node.index = i;
				    node.count = 0;
				    matrix[i] = d3.range(n).map(function(j) { 
					return {x: j, y: i, z: 0}; });
				  });
				  
				  var dropDownNodes = new Array();
				  json.nodes.forEach(function(d) {
					if (d.id ){
						dropDownNodes.push(d.id.toLowerCase());
					}
				  });
				  dropDownNodes.sort();
				  dropDownNodes.unshift("all"); 

				  var dropDown = d3.select("#chooseNode")
				    .selectAll("option")
				    .data(dropDownNodes)
				    .enter()
				    .append("option")
				    .attr("value", function(d) { return d;} )
				    .text(function(d) {return d;});


				  // Convert links to matrix; count character occurrences.
				  json.links.forEach(function(link) {
					if (matrix[link.source][link.target] === undefined) {
						console.log("SourceTargetMapping missing");
					}
					else {
					    matrix[link.source][link.target].z += link.value;
					    matrix[link.target][link.source].z += link.value;
					    matrix[link.target][link.target].z += link.value;
					    matrix[link.source][link.source].z += link.value;
					    nodes[link.source].count += link.value;
					    nodes[link.target].count += link.value;
					}
				  });
				
				  // Precompute the orders.
				  var orders = {
				    name: d3.range(n).sort(function(a, b) { return d3.ascending(nodes[a].id, nodes[b].id); }),
				    count: d3.range(n).sort(function(a, b) { return nodes[b].count - nodes[a].count; }),
				    degree: d3.range(n).sort(function(a, b) { return nodes[b].degree - nodes[a].degree; })
				  };

				  // The default sort order.
				  x.domain(orders.name);

				  svg.append("rect")
				      .attr("class", "background")
				      .attr("width", width)
				      .attr("height", height)
				      .attr("x", 100)
				      .attr("y", 0);

				  var row = svg.selectAll(".row")
				      .data(matrix)
				    .enter().append("g")
				      .attr("class", "row")
				      .attr("transform", function(d, i) { return "translate(100," + x(i) + ")"; })
				      .each(row);

				  row.append("line")
				      .attr("x2", width);

				  console.log(x.rangeBand())

				  row.append("text")
				      .attr("x", 0)
				      .attr("y", x.rangeBand() / 2)
				      .attr("dy", ".32em")
				      .attr("text-anchor", "end")
				      .text(function(d, i) { return nodes[i].id.toLowerCase(); })
				      .attr('font-size', 2);

				  var column = svg.selectAll(".column")
				      .data(matrix)
				    .enter().append("g")
				      .attr("class", "column")
				      .attr("transform", function(d, i) { return "translate(" + x(i) + ")rotate(-90)"; });

				  column.append("line")
				      .attr("x1", -width);

				  column.append("text")
				      .attr("x", 0)
				      .attr("y", 100 + x.rangeBand() / 2)
				      .attr("dy", ".32em")
				      .attr("text-anchor", "start")
				      .text(function(d, i) { return nodes[i].id.toLowerCase(); })
				      .attr('font-size', 2);

				  function row(row) {
				    var cell = d3.select(this).selectAll(".cell")
					.data(row.filter(function(d) { return d.z; }))
				      .enter().append("rect")
					.attr("class", "cell")
					.attr("x", function(d) { return x(d.x + 100); })
					.attr("width", x.rangeBand())
					.attr("height", x.rangeBand())
					.style("fill-opacity", function(d) { return z(d.z); })
					.style("fill", function(d) {
						return c(d.z); }) 
					.on("mouseover", mouseover)
					.on("mouseout", mouseout);
				  }

				  function mouseover(p) {
				    d3.selectAll(".row text").classed("active", function(d, i) { return i == p.y; });
				    d3.selectAll(".column text").classed("active", function(d, i) { return i == p.x; });
				  }

				  function mouseout() {
				    d3.selectAll("text").classed("active", false);
				  }

				  d3.select("#order").on("change", function() {
				    clearTimeout(timeout);
				    order(this.value);
				  });

				  function order(value) {
				    orderingParam = value;
				    x.domain(orders[value]);

				    var t = svg.transition().duration(2500);

				    t.selectAll(".row")
					.delay(function(d, i) { return x(i) * 4; })
					.attr("transform", function(d, i) { return "translate(100," + x(i) + ")"; })
				      .selectAll(".cell")
					.delay(function(d) { return x(d.x) * 4; })
					.attr("x", function(d) { return x(d.x); });

				    t.selectAll(".column")
					.delay(function(d, i) { return x(i) * 4; })
					.attr("transform", function(d, i) { return "translate(" + x(i) + ")rotate(-90)"; });
				  }

				  var timeout = setTimeout(function() {
				    order("degree");
				    d3.select("#order").property("selectedIndex", 2).node().focus();
				  }, 5000);
				});
			}

		</script>
	</body>
</html>
